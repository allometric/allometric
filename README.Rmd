---
output: github_document
---

```{r include=FALSE}
library(dplyr)
library(tidyr)


library(allometric)
options(width = 10000)

knitr::opts_chunk$set(
  comment = "#>"
)

if(!exists("allometric_models")) {
  allometric::install_models()
}

n_models <- nrow(allometric_models)
n_pubs <- length(unique(allometric_models$pub_id, na.rm = T))
```

# allometric <a href="https://brycefrank.com/allometric/"><img src='man/figures/logo.png' align="right" height="139" /></a>

<!-- badges: start -->
[![R-CMD-check](https://github.com/brycefrank/allometric/actions/workflows/check-standard.yaml/badge.svg)](https://github.com/brycefrank/allometric/actions/workflows/check-standard.yaml)
<!-- badges: end -->

`allometric` is an open source R package for predicting tree attributes using
allometric models. Thousands of allometric models exist in the
scientific and technical forestry literature. `allometric` is a platform for
archiving and using this vast array of models in a robust and structured format.

`allometric` not only enables the use of allometric models for analysis, it 
also provides a structured language for adding models to the package. If you
are interested in helping the developer in this process please refer to the 
[Installing a Model](https://brycefrank.com/allometric/articles/installing_a_model.html) vignette.

Currently, `allometric` contains `r n_models` allometric models across
`r n_pubs` publications.

## Installation

Currently `allometric` is only available on GitHub, and can be installed using
`devtools`.

```{r eval=FALSE}
devtools::install_github("brycefrank/allometric")
```

## Getting Started

Most users will only be interested in finding and using allometric equations in
their analysis. `allometric` allows rapid searching of currently installed
models.

Before beginning, make sure to install the models locally by running

```{r eval=F}
library(allometric)
install_models()
```

This compiles the allometric models, and enables their use. `install_models`
only needs to be ran at installation, or following any package updates. After
running this function, the models are available in the variable
`allometric_models`.

```{r}
head(allometric_models)
```

**Finding and Selecting a Model**

`allometric_models` is a `tibble::tbl_df` dataframe. Each row represents one 
allometric model with various attributes. Some columns are `list` columns, which
are columns that contain lists with multiple values as their elements. One 
example of this is the `family_names` column, which contains the names of all
authors for the publication that contains the model. 

`list` columns enable rigorous searching of models covered in the
[Advanced Model Searching](https://brycefrank.com/allometric/articles/advanced_searching.html)
vignette, but to get started we will use a helper function called
`unnest_models` that will give us a clearer picture of the available data.

```{r}
unnested_models <- unnest_models(allometric_models)
unnested_models
```

Now, each row represents unique data combinations for each model, which can be
quickly filtered by most users using `dplyr::filter`. For example, to find a 
volume model for the genus Alnus that had `"Brackett"` as an author or co-author
we can use

```{r}
brackett_alnus_vol <- unnested_models %>%
  dplyr::filter(family_names == "Brackett", measure=="volume",
    genus=="Alnus")

brackett_alnus_vol
```

we can see that model `07d06ce8` is a volume model written by Brackett for 
*Alnus rubra*. The model can be selected using the `id` field:

```{r}
brackett_alnus_mod <- brackett_alnus_vol %>% select_model("07d06ce8")
```

or by using the row index

```{r eval=F}
brackett_alnus_mod <- brackett_alnus_vol %>% select_model(1)
```

**Determine Needed Information**

`brackett_alnus_mod` now represents an allometric model that can be used for 
prediction.

Using the standard output of `brackett_alnus_mod` we obtain a summary of the model form,
the response variable, the needed covariates and their units, a summary of
the model descriptors (i.e., what makes the model unique within the
publication), and estimates of the parameters.

```{r}
brackett_alnus_mod
```

We can see here that `brackett_alnus_mod` will require two covariates called `dsob`, which
refers to diameter outside bark at breast height, and `hst`, the height of the
main stem. 

**Predict Using the Selected Model**

Using the `predict` method we can easily use the function as defined
by providing values of these two covariates.

```{r eval=T}
predict(brackett_alnus_mod, 12, 65)
```

or we can use the prediction function with a data frame of values

```{r}
my_trees <- data.frame(dias = c(12, 15, 20), heights = c(65, 75, 100))
predict(brackett_alnus_mod, my_trees$dias, my_trees$heights)
```

or even using the convenience of `dplyr`

```{r}
my_trees %>%
  mutate(vols = predict(brackett_alnus_mod, dias, heights))
```

This is all that is needed to make predictions using the models stored in 
`allometric`. Please refer to the following vignettes for further possibilities
with this package.
