---
title: Advanced Model Searching
---

```{r include=F}
library(allometric)
```

Upon installation the user is able to access models stored in 
`allometric_models`. This represents a dataframe containing highly structured
data describing the models contained in the package. Using packages like `dplyr`
and `purrr` we will be able to create expressive search queries to find the 
models we need. This vignette shares some motivating examples. After following
the examples, users should feel confident writing their own expressive queries.

### Finding Contributing Authors

Let's say we want to search for any model with `'Hann'` as a contributing author.
This can be done with some elegant use of `dplyr::filter` and `purrr::map_lgl`.
Before beginning, it is helpful to know that `purrr::map_lgl` returns a list
of TRUE/FALSE values as it "maps" over a list of input.

Consider the vector `auth <- c('Hann', 'Doe')`, I could check if this vector 
contains `'Hann'` using the expression `'Hann' %in% auth`. Knowing this, let's
take a look at filtering out all models containing `Hann` as an author:

```{r}
hann_models <- dplyr::filter(
  allometric_models,
  purrr::map_lgl(family_names, ~ 'Hann' %in% .)
)

head(hann_models)
nrow(hann_models)
```

Picking apart the above code block, we see that we are using the standard 
`dplyr::filter` function on the `allometric_models` dataframe. The second 
argument is a call using `purrr:map_lgl`, which will map over each list 
(contained as elements in the `family_names` column). The second argument to
this function, `~ 'Hann' %in% .` is itself a function that checks if `'Hann'` is
in the current list. Imagine we are marching down each row of `allometric_models`,
`.` represents the element of `family_names` we are considering, which is itself
a list of author names.

### Finding First Authors

Maybe we are only interested in models where `'Hann'` is the first author. Using
a simple modification we can easily do this.

```{r}
hann_first_author_models <- dplyr::filter(
  allometric_models,
  purrr::map_lgl(family_names, ~ 'Hann' == .[[1]])
)

head(hann_first_author_models)
nrow(hann_first_author_models)
```

We can see that `'Hann'` is the first author for 18 models in this package.

### Finding a Model with Specific Data Requirements

We can even check for models that contain certain types of data requirements. 
For example, the following block finds diameter-height models, specifically 
models that use diameter outside bark at breast height as the *only* covariate.
The utility here is obvious, since many inventories are vastly limited by their
available tree measurements.

```{r}
dia_ht_models <- dplyr::filter(
    allometric_models,
    measure == 'height',
    purrr::map_lgl(covt_names, ~ length(.)==1 & .[[1]] == 'dsob'),
)

nrow(dia_ht_models)
```

Breaking this down, we have the first condition `measure=='height'` selecting
only models concerned with heights as a response variable. The second line 
maps over each element of the `covt_names` column, which is a character vector.
The `.` represents a given character vector for that row. First, we ensure that
the vector is only one element in size using `length(.)==1`, then we ensure that
the first (and only) element of this vector is equal to `'dsob'`, (diameter
outside bark at breast height). In this case, `r nrow(dia_ht_models)` are 
available in the package.

### Finding a Model for a Region

By now the user should be sensing a pattern. We can apply the exact same logic
as the *Finding Contributing Authors* section to find all models developed using
data from `US-OR`

```{r}
us_or_models <- dplyr::filter(
    allometric_models,
    purrr::map_lgl(region, ~ "US-OR" %in% .),
)

nrow(us_or_models)
```

We can see that `r nrow(us_or_models)` allometric models are defined for the 
state of Oregon, US.